<!DOCTYPE html>
<html>

<body>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.1.0/rxjs.umd.js"></script>
    <script>
        (async () => {

            const tz = () => {
                return Intl.DateTimeFormat().resolvedOptions().timeZone;
            };

            const uuidv4 = () => {
                if (window.crypto && window.crypto.getRandomValues) {
                    return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
                }

                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
                    const r = Math.random() * 16 | 0;
                    const v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }


            const message = new rxjs.Subject();

            const connect = async (url) => {
                return new Promise((resolve, reject) => {
                    const socket = new WebSocket(url);

                    socket.addEventListener("open", (event) => {
                        console.log('Connected to WebSocket server');
                        resolve(socket);
                    });

                    socket.addEventListener("error", (event) => {
                        console.error('WebSocket error:', event);
                        reject(event);
                    });


                    socket.addEventListener("message", (data) => {
                        message.next(JSON.parse(data.data));
                    });

                });
            }
            const ws = await connect("ws://10.245.111.11:7081/wdx/ws");

            const getValue = async (path) => {
                return new Promise((resolve, reject) => {
                    const uuid = uuidv4();
                    const m = { timestamp: Date.now(), uuid: uuid, timezone: tz(), body: path, type: "DataGetValueRequest" };
                    const subscription = message.subscribe((data) => {
                        if (uuid === data.uuid) {
                            subscription.unsubscribe();
                            resolve(data.body.value);
                        }
                    });
                    ws.send(JSON.stringify(m));
                });
            };

            const setValue = async (path, value) => {
                return new Promise((resolve, reject) => {
                    const uuid = uuidv4();
                    const m = { timestamp: Date.now(), uuid: uuid, timezone: tz(), body: { path: path, value: value }, type: "DataSetValueRequest" };
                    const subscription = message.subscribe((data) => {
                        if (uuid === data.uuid) {
                            subscription.unsubscribe();
                            resolve();
                        }
                    });
                    ws.send(JSON.stringify(m));
                });
            };
            await setValue('Virtual.test-virtual.speedy', 1);
            const bValue = await getValue('Virtual.test-virtual.speedy');
            console.log('bValue', bValue);


        })();
    </script>


</body>

</html>